$((function(){var e=$('select[name="lines"]'),t=$('select[name="file_name"]'),n=$('select[name="search_sign"]'),i=$(".log_left"),r=$("#log_win"),a=$('[name="user_name"]').val(),o=null,l=j("env_code",location.href)||"",s=$('[name="path"]').val(),c=s.split(":"),d=(c[0],c=(c[1]||"").split("/"),k("app")),u=k("server_name"),h=k("node_name");function f(){var e=$(window).height(),t=$("body").width();i.height(e).width(500),r.width(t-500),r.height(e).css({right:0,left:500})}cloudjs(e).combobox(),cloudjs(t).combobox(),cloudjs(n).combobox(),cloudjs(".ctip").tips({position:"down"}),f();var m=null,_=!1;$(window).resize((function(){m&&clearTimeout(m),_||(m=setTimeout((function(){f(),m=null}),150))}));cloudjs("#log_win").resizable({handles:"w",start:function(e,t){_=!0},stop:function(e,t){_=!1;var n=$("body").width()-t.size.width;i.width(n)}}),$("#auto_btn").bind("change",(function(){$(this).prop("checked")?(clearTimeout(o),o=setTimeout((function(){$("#search_btn").trigger("click")}),6e3)):clearTimeout(o)}));var p=!1;function v(){p=!0,$(".refresh_btn").removeClass("icon-refresh").addClass("icon-spinner icon-spin hover4");var e=s.split(":");e[0],e[1];$.ajax({url:"/pages/server/api/logview_list",data:{operator:a,application:d,server_name:u,node_name:h},dataType:"json",success:function(e){p=!1,$(".refresh_btn").removeClass("icon-spinner icon-spin hover4").addClass("icon-refresh");var t=JSON.parse(e.data);0==t.iRet?(cloudjs.message({content:"刷新日志文件列表成功",type:"success",relative:".log_left"}),g(t.data)):cloudjs.message({content:"刷新日志文件列表失败，失败原因："+e.err_msg,type:"error",relative:".log_left"})},error:function(){p=!1,$(".refresh_btn").removeClass("icon-spinner icon-spin hover4").addClass("icon-refresh"),cloudjs.message({content:"刷新日志文件列表失败",type:"error",relative:".log_left"})}})}function g(e){e=b(e);for(var n=[],i="",r=0,a=e.length;r<a;r++)n.push({text:e[r],value:e[r]}),i+="<li>"+e[r]+"</li>";var o={data:n};e.length&&(o.defaultValue=e[0]),cloudjs(t).combobox("refresh",o),$(".file_list ul").html(i),i?$(".file_list .empty_notice_p").hide():$(".file_list .empty_notice_p").show(),y()}function b(e){var t=d+"."+u+".log";Array.indexOf||(Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1});var n=e.indexOf(t);return n>=0&&(e.splice(n,1),e.unshift(t)),e}$(".refresh_btn").bind("click",(function(){p||v()})),v();var w=$("<div></div>");function x(e){return w.text(e),w.html()}function y(){$(".file_list li").bind("click",(function(){var e=$(this).text();cloudjs(t).combobox("setValue",e)}))}function j(e,t){if(!t||!e)return null;var n=t,i=n.indexOf("?");if(-1===i)return null;var r=n.substring(i),a=r.indexOf("&"+e+"=");-1==a&&(a=r.indexOf("?"+e+"="));var o="";if(-1==a)return null;a+=e.length+2;var l=r.indexOf("&",a);o=r.substring(a,-1==l?r.length:l);var s=o.indexOf("#");return-1!==s&&(o=o.substring(0,s)),o}function k(e){var t=window.location.href;return j(e,t)}function O(){var e=new Date,t="-",n=":",i=e.getMonth()+1,r=e.getDate();i>=1&&i<=9&&(i="0"+i),r>=0&&r<=9&&(r="0"+r);var a=e.getFullYear()+t+i+t+r+" "+T(e.getHours())+n+T(e.getMinutes())+n+T(e.getSeconds());return a}function T(e){while((e+"").length<2)e="0"+e;return e}y(),$("#search_btn").bind("click",(function(e){var n=$(this),i={view_direction:$('[name="view_direction"]:checked').val(),file_name:$(t).parent().children(".combo_value").val(),ignoreCase:$('[name="ignoreCase"]').prop("checked")?"Y":"N",lines:$('[name="lines"]').val(),keyword:$('[name="keyword"]').val(),search_lines:$('[name="search_lines"]').val(),search_sign:$('[name="search_sign"]').val(),env_code:l};null!==i.file_name?($("#log_win_content").html('<p style="margin:10px">Loading....</p>'),n.attr("disabled","disabled"),n.text("查询中..."),$.ajax({url:"/pages/server/api/logview_data",data:{operator:a,interface_params:JSON.stringify(i),application:d,server_name:u,node_name:h,log_file:$(t).parent().children(".combo_value").val()},dataType:"json",timeout:6e4,success:function(e){if(e=JSON.parse(e.data),0==e.iRet){var t=e.cmd||"";t=O()+"===>"+t,$("#cmd_row").show().children(".cmd").html(x(t));var i='<table class="code_table">',r=e.data,a=r.split("\n"),l=a.length;if(l>0)for(var s=0;s<l;s++)i+='<tr><td class="line_td" data-line-num="'+(s+1)+'"></td><td>'+x(a[s])+"</td></tr>";else i+="<tr><td>执行结果为空</td></tr>";$("#log_win_content").html(i)}else $("#log_win_content").html('<p style="margin:10px">查询失败，错误信息：'+e.err_msg+"</p>");n.removeAttr("disabled"),n.text("提交查询"),$("#auto_btn").prop("checked")&&(clearTimeout(o),o=setTimeout((function(){$("#search_btn").trigger("click")}),6e3))},error:function(){$("#log_win_content").html('<p style="margin:10px">查询失败。</p>'),n.removeAttr("disabled"),n.text("提交查询"),$("#auto_btn").prop("checked")&&(clearTimeout(o),o=setTimeout((function(){$("#search_btn").trigger("click")}),6e3))}})):alert("日志文件不能为null")}))}));